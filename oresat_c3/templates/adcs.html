{% extends "base.html" %}

{% block content %}
  <style>
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      margin-left: auto;
      margin-right: auto;
    }
    thead {
      font-weight: bold;
    }
    td, th {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }
  </style>
  <b>The current branch is for testing the ADCS service!</b>
  <br/>
  <form>
    <br/>
    <input id="apply_button" type="button" value="APPLY"></input>
    <input id="reset_button" type="reset" value="RESET"></input>
    <br/>
    <div id="adcsMgrTableDiv">
      <table id="adcsMgrTable">
        <thead>
          <tr>
            <td>Name</td>
	    <td>Control Signal Form</td>
            <td>Applied Control Signal</td>
            <td>Feedback Signal</td>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </form>
  <script>
    async function updateFeedbackValues() {
      let feedback_json = await readValue("adcs_manager", "feedback");
      let feedback = JSON.parse(feedback_json.value);
      for (let actuator in feedback) {
	let feedback_element = document.getElementById(`feedback-${actuator}`);
	feedback_element.innerHTML = feedback[actuator];
      }
    }
    

    async function applyControlSignals() {
      console.log("submitting control signals");
      let ctrl_inputs = document.getElementsByClassName("ctrl_input");
      console.log(ctrl_inputs);
      let ctrl_signals = {};
      for (const ctrl_input_element of ctrl_inputs) {
        // Send write values for c3 card to send control signal
	
	let name = ctrl_input_element.id.split("-")[1];
	let ctrl_signal = document.getElementById(`signal-${name}`);
	ctrl_signal.innerText = ctrl_input_element.value;
	ctrl_signals[name] = parseInt(ctrl_input_element.value);
      }
      writeValue("adcs_manager", "signals", JSON.stringify(ctrl_signals));
      return 0;
    }

    async function resetControlSignals() {
      // sets all control inputs to zero and submits
      console.log("resetting control signals");
      let ctrl_inputs = document.getElementsByClassName("ctrl_input");
      for (const ctrl_input_element of ctrl_inputs) {
        ctrl_input_element.value = "0";
      }
      applyControlSignals();
    }

    async function buildTable() {
      let tbodyRef = document.getElementById("adcsMgrTable").getElementsByTagName("tbody")[0];
      let feedback_json = await readValue("adcs_manager", "feedback");
      let feedback = JSON.parse(feedback_json.value);
      for (let actuator in feedback) {
	console.log(actuator);
	let newRow = tbodyRef.insertRow();

	// Row name
	let nameCell = newRow.insertCell();
	let nameText = document.createTextNode(actuator);
	nameCell.appendChild(nameText);

	// Form input values
	let inputCell = newRow.insertCell();
	let inputField = document.createElement("input");
	inputField.id = `input-${actuator}`;
	inputField.type = "number";
	inputField.value = "0";
	inputField.classList.add("ctrl_input");
	inputCell.appendChild(inputField)

	// Applied signal Values
	let signalCell = newRow.insertCell();
	let signalSpan = document.createElement("span");
	signalSpan.id = `signal-${actuator}`;
	signalSpan.innerText = "0";
	signalCell.appendChild(signalSpan);
	signalCell.classList.add("ctrl_signal");
	
	// Feedback values
	let feedbackCell = newRow.insertCell();
	let feedbackSpan = document.createElement("span");
	feedbackSpan.id = `feedback-${actuator}`;
	feedbackSpan.class = "ctrl_feedback"
	feedbackSpan.innerText = feedback[actuator];
	feedbackCell.appendChild(feedbackSpan);
      }
    }
    

    // setup
    buildTable();
    // make custom event listener for reset button
    document.getElementById("reset_button").addEventListener("click", function(e) {e.preventDefault(); resetControlSignals();})
    // make custom event listener for apply button
    document.getElementById("apply_button").addEventListener("click", applyControlSignals)
    const interval = setInterval(function() {
      updateFeedbackValues();
    }, 100);
	  
  </script>
{% endblock %}
